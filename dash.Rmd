---
title: "Colombian variant population"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(flexdashboard)
library("ggplot2")
library("arules")
library("arulesViz")
library("visNetwork")
library("tidyr")
library("dplyr")
library("magrittr")
library("igraph")
library("stringr")
library("plotly")
```


```{r include=FALSE}
par_clust <- "x" #cluster
par_n <- 5 #NÃºmero de Cluster
par_tipo <- "confidence"

genes <- read.csv('/home/jennifer/Escritorio/cluster1.csv') 
#genes$edad1 <- gsub(",","-",genes$edad1)#Cambio de coma
#genes %<>% filter(cluster %in% c('c1','c5','c3','c4','c2'))
#genes %<>% filter(cluster %in% c('c1','c3','c5'))
#genes %<>% filter(gen %in% c("BARD1"))#,"BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"))

#genes %<>% select(-cluster)

#genes <- sapply(genes,as.factor)
#genes$cluster <- discretize(genes$cluster)
#genes$edad <- discretize(genes$edad)
#genes$sexo <- discretize(genes$sexo)
g <- as(genes, "transactions")
rules <- apriori(g, parameter = list(supp = 0.05, conf = 0.6, target = "rules"))
#rules <-sort(rules, by ="lift")
#gato <- as(rules,"data.frame")
gatos <- data.frame(lhs = labels(lhs(rules)), rhs = labels(rhs(rules)), rules@quality) 
gatos$id <- rownames(gatos)
gatos %>% filter((grepl("BRCA1",lhs)|grepl("BRCA2",lhs)|grepl("ATM",lhs))) %>% select(id)-> rules_filtered
rules_filtered <- as.vector(rules_filtered) #Filtro de reglas por gen.

#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

summary(rules)
inspect(rules)

#plot(rules[1:5], method="graph", control=list(type="items"))
#plot(rules[1:10], method="graph", control=list(type="items"))
#plot(rules[1:5], method="grouped", interactive=TRUE)
#plot(rules[10:15], method="graph", control=list(type="items"))
#plot(rules, method="graph", control=list(type="items"))
#plot(rules, method = "graph", control = list(type = "items", + engine = "graphviz"))

inspect(head(rules, by = "lift"))
## filter spurious rules 
inspect(rules, by = "lift")
#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

#####


####### Codigo se Grafico ########

#Crear dataframe
rules_test <- rules[1:10,] # Filtro de reglas. 

df_rules = data.frame(
  lhs = labels(lhs(rules_test)),
  rhs = labels(rhs(rules_test)), 
  rules_test@quality)

#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
# Ajustar contenido de las celdas
df_rules$regla <- rownames(df_rules)
df_rules$lhs <- gsub("[\\{\\}]", "", df_rules$lhs)
df_rules$rhs <- gsub("[\\{\\}]", "", df_rules$rhs)

#### Ajustar a formato de tres tablas

## left hand 
lista <- str_split(df_rules$lhs,",")
names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame
df_reglas_lhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),titulo = unlist(lista), type = "from")

## right hand
lista <- str_split(df_rules$rhs,",")

names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame

df_reglas_rhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),
                            titulo = unlist(lista),type = "to")

df_reglas_lhs$regla <- paste("rule",df_reglas_lhs$regla,sep = "")
df_reglas_rhs$regla <- paste("rule",df_reglas_rhs$regla,sep = "")


# Propiedades
df_rules <- df_rules[,c("regla","support", "confidence", "lift")]
df_rules$regla <- paste("rule",df_rules$regla,sep = "")

df1 <- rbind(df_reglas_lhs,df_reglas_rhs)

df1n1 <- data.frame(edge = df1$regla, type = rep("regla",dim(df1)[1]))
df1n2 <- data.frame(edge = df1$titulo, type = rep("Condicion",dim(df1)[1]))
dfn <- rbind(df1n1,df1n2) 

colnames(df_reglas_rhs) <- c("origen","destino","type")
colnames(df_reglas_lhs) <- c("destino","origen","type")
df_reglas_gato <- rbind (df_reglas_lhs,df_reglas_rhs)

dfnodos <- dfn %>% group_by(edge,type) %>% summarise(n = n())

nodes <- data.frame(id = dfnodos$edge, group = dfnodos$type, label = dfnodos$edge)
edges <- data.frame(from = df_reglas_gato$origen ,to=df_reglas_gato$destino)
set.seed(1234)
```


Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r }
a<-visNetwork(nodes, edges, width = "90%") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  #visNodes(shape = "square") %>%                        # square for all nodes
  visEdges(arrows ="to") %>%                            # arrow "to" for all edges
  visGroups(groupname = "regla") %>%    # darkblue for group "A"
  visGroups(groupname = "Condicion",shape = "icon",icon = list(code = "f007", color = "pink"), color = "red")

visExport(graph= a,type = "png", name = "network",
                      label = paste0("Export as png"), background = "#fff",
                      float = "left", style = NULL, loadDependencies = TRUE)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r echo=FALSE}
set.seed(955)
dat <- data.frame(cond = rep(c("A", "B"), each=10),
                  xvar = 1:20 + rnorm(20,sd=3),
                  yvar = 1:20 + rnorm(20,sd=3))
p <- ggplot(dat, aes(x=xvar, y=yvar)) + geom_point(shape=1)      # Use hollow circles
ggplotly(p)

``` 
### Chart C

```{r echo=FALSE}
#knitr::include_graphics("/home/jennifer/Documentos/clusters/cluster1.png")
```

