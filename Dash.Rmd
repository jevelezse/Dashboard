---
title: "Colombian variant population"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
runtime: shiny
---

```{r setup, include=FALSE}
rm(list=ls())
library(flexdashboard)
library("ggplot2")
library("arules")
library("arulesViz")
library("visNetwork")
library("tidyr")
library("dplyr")
library("magrittr")
library("igraph")
library("stringr")
library("plotly")
```

General 
=====================================

```{r include=FALSE}
conteos <- read.csv('variantes.csv', header = TRUE)
#y = c(447171,344259,10036,1901,371,56,40,24,20,458639,345239,344031,146231,123953,84780,47564,37376,19943,468485,335393,166391,161567,160208,157947,157765)

data <- as.data.frame(conteos)
v <-reorder(data$Caracteristica,data$Observaciones) #ordenar y convertir en factores
p <- plot_ly(data, x= ~Observaciones, y= v ,type = "bar",
             text = data$Observaciones, textposition = 'auto',
             marker = list(color = 'rgb(158,202,225)'))%>% 
  layout(title = "",
         yaxis = list(title = "", type = "category"),
         xaxis = list(title = "",
                     zeroline = FALSE,
                     showline = FALSE,
                     showticklabels = FALSE,
                     showgrid = FALSE),
         margin = list(l = 200)) 
```

Column {data-width=600}
-----------------------------------------------------------------------

### Chart A

```{r}
p
```


Cluster 1 
=====================================  
```{r include=FALSE}
par_clust <- "x" #cluster
par_n <- 5 #Número de Cluster
par_tipo <- "confidence"

genes <- read.csv('cluster1.csv') 
#genes$edad1 <- gsub(",","-",genes$edad1)#Cambio de coma
#genes %<>% filter(cluster %in% c('c1'))
#genes %<>% filter(cluster %in% c('c1','c3','c5'))
#genes %<>% filter(gen %in% c("BARD1"))#,"BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"))

#genes %<>% select(-cluster)

#genes <- sapply(genes,as.factor)
#genes$cluster <- discretize(genes$cluster)
#genes$edad <- discretize(genes$edad)
#genes$sexo <- discretize(genes$sexo)
g <- as(genes, "transactions")
rules <- apriori(g, parameter = list(supp = 0.05, conf = 0.6, target = "rules"))
#rules <-sort(rules, by ="lift")
#gato <- as(rules,"data.frame")
gatos <- data.frame(lhs = labels(lhs(rules)), rhs = labels(rhs(rules)), rules@quality) 
gatos$id <- rownames(gatos)
gatos %>% filter((grepl("BRCA1",lhs)|grepl("BRCA2",lhs)|grepl("ATM",lhs))) %>% select(id)-> rules_filtered
rules_filtered <- as.vector(rules_filtered) #Filtro de reglas por gen.

#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

summary(rules)
inspect(rules)

#plot(rules[1:5], method="graph", control=list(type="items"))
plot(rules[1:10], method="graph", control=list(type="items"))
##plot(rules[1:5], method="grouped", interactive=TRUE)
#plot(rules[10:15], method="graph", control=list(type="items"))
#plot(rules, method="graph", control=list(type="items"))
#plot(rules, method = "graph", control = list(type = "items", + engine = "graphviz"))

inspect(head(rules, by = "lift"))
## filter spurious rules 
inspect(rules, by = "lift")
#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

#####


####### Codigo se Grafico ########

#Crear dataframe
rules_test <- rules[1:10,] # Filtro de reglas. 

df_rules = data.frame(
  lhs = labels(lhs(rules_test)),
  rhs = labels(rhs(rules_test)), 
  rules_test@quality)

#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
# Ajustar contenido de las celdas
df_rules$regla <- rownames(df_rules)
df_rules$lhs <- gsub("[\\{\\}]", "", df_rules$lhs)
df_rules$rhs <- gsub("[\\{\\}]", "", df_rules$rhs)

#### Ajustar a formato de tres tablas

## left hand 
lista <- str_split(df_rules$lhs,",")
names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame
df_reglas_lhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),titulo = unlist(lista), type = "from")

## right hand
lista <- str_split(df_rules$rhs,",")

names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame

df_reglas_rhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),
                            titulo = unlist(lista),type = "to")

df_reglas_lhs$regla <- paste("rule",df_reglas_lhs$regla,sep = "")
df_reglas_rhs$regla <- paste("rule",df_reglas_rhs$regla,sep = "")


# Propiedades
df_rules <- df_rules[,c("regla","support", "confidence", "lift")]
df_rules$regla <- paste("rule",df_rules$regla,sep = "")

df1 <- rbind(df_reglas_lhs,df_reglas_rhs)

df1n1 <- data.frame(edge = df1$regla, type = rep("regla",dim(df1)[1]))
df1n2 <- data.frame(edge = df1$titulo, type = rep("Condicion",dim(df1)[1]))
dfn <- rbind(df1n1,df1n2) 

colnames(df_reglas_rhs) <- c("origen","destino","type")
colnames(df_reglas_lhs) <- c("destino","origen","type")
df_reglas_gato <- rbind (df_reglas_lhs,df_reglas_rhs)

dfnodos <- dfn %>% group_by(edge,type) %>% summarise(n = n())

nodes <- data.frame(id = dfnodos$edge, group = dfnodos$type, label = dfnodos$edge)
edges <- data.frame(from = df_reglas_gato$origen ,to=df_reglas_gato$destino)
set.seed(1234)

a<-visNetwork(nodes, edges, width = "90%") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  #visNodes(shape = "square") %>%                        # square for all nodes
  visEdges(arrows ="to") %>%                            # arrow "to" for all edges
  visGroups(groupname = "regla") %>%    # darkblue for group "A"
  visGroups(groupname = "Condicion",shape = "icon",icon = list(code = "f007", color = "pink"), color = "red")
```

Column {data-width=600}
-----------------------------------------------------------------------

### Chart A

```{r echo=FALSE}
a
```


Column {data-width=400}
-----------------------------------------------------------------------

### Chart B

```{r echo=FALSE}
#Carga y formula
datos <-read.csv("/home/jennifer/Descargas/ideds.csv")
datos$EdadRango <- discretize(datos$Edad,method = "fixed", categories = c(-Inf,seq(0,65,5),Inf),labels = c("<0","0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64",">65"))
## Caracterización general
#General
datos %>% group_by(EdadRango, Genero) %>% summarise(Poblacion=n()) %>% mutate(Edad = EdadRango) %>% ggplot() + geom_bar(aes(x=Edad, y = if_else(Genero=="M", -Poblacion,Poblacion), fill = Genero), stat="identity") + coord_flip() +theme_minimal() + xlab("Edad")+ ylab("Observaciones") + scale_y_continuous(labels = abs)-> ggcaracterizacion

datos$Cluster <- paste("Cluster", datos$Cluster, sep= " ")
#ggcaracterizacion
#ggplotly(ggcaracterizacion)

## Caracterización por cluster

datos %>% group_by(EdadRango, Genero, Cluster) %>% summarise(Poblacion=n())%>% mutate(Edad = EdadRango) %>% ggplot() + geom_bar(aes(x=Edad, y = if_else(Genero=="M", -Poblacion,Poblacion), fill = Genero), stat="identity") + coord_flip() + facet_wrap( ~ Cluster, ncol = 3) +theme_minimal() + xlab("Edad")+ ylab("Observaciones") + scale_y_continuous(labels = abs)-> ggcaracterizacion

#ggcaracterizacion
#ggplotly(ggcaracterizacion)

datos$EdadRango <- discretize(datos$Edad,method = "fixed", categories = c(-Inf,seq(0,60,10),Inf),labels = c("<0","0-9","10-19","20-29","30-39","40-49","50-59",">60"))

datos %>% filter(Cluster %in% c("Cluster 1")) %>% group_by(EdadRango, Genero, Cluster) %>% summarise(Poblacion=n())%>% mutate(Edad = EdadRango) %>% ggplot() + geom_bar(aes(x=Edad, y = if_else(Genero=="M", -Poblacion,Poblacion), fill = Genero), stat="identity") + coord_flip() + facet_wrap( ~ Cluster, ncol = 2) +theme_minimal() + xlab("Edad")+ ylab("Observaciones") + scale_y_continuous(labels = abs)-> ggcaracterizacion

ggplotly(ggcaracterizacion)
``` 

### Chart C

```{r echo=FALSE}
knitr::include_graphics("/home/jennifer/Documentos/clusters/cluster1.png")
```


Cluster 2
===================================== 


```{r include=FALSE}
par_clust <- "x" #cluster
par_n <- 5 #Número de Cluster
par_tipo <- "confidence"

genes <- read.csv('cluster2.csv') 
#genes$edad1 <- gsub(",","-",genes$edad1)#Cambio de coma
#genes %<>% filter(cluster %in% c('c1','c5','c3','c4','c2'))
#genes %<>% filter(cluster %in% c('c1','c3','c5'))
#genes %<>% filter(gen %in% c("BARD1"))#,"BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"))

#genes %<>% select(-cluster)

#genes <- sapply(genes,as.factor)
#genes$cluster <- discretize(genes$cluster)
#genes$edad <- discretize(genes$edad)
#genes$sexo <- discretize(genes$sexo)
g <- as(genes, "transactions")
rules <- apriori(g, parameter = list(supp = 0.05, conf = 0.6, target = "rules"))
#rules <-sort(rules, by ="lift")
#gato <- as(rules,"data.frame")
gatos <- data.frame(lhs = labels(lhs(rules)), rhs = labels(rhs(rules)), rules@quality) 
gatos$id <- rownames(gatos)
gatos %>% filter((grepl("BRCA1",lhs)|grepl("BRCA2",lhs)|grepl("ATM",lhs))) %>% select(id)-> rules_filtered
rules_filtered <- as.vector(rules_filtered) #Filtro de reglas por gen.

#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

summary(rules)
inspect(rules)

#plot(rules[1:5], method="graph", control=list(type="items"))
#plot(rules[1:10], method="graph", control=list(type="items"))
#plot(rules[1:5], method="grouped", interactive=TRUE)
#plot(rules[10:15], method="graph", control=list(type="items"))
#plot(rules, method="graph", control=list(type="items"))
#plot(rules, method = "graph", control = list(type = "items", + engine = "graphviz"))

inspect(head(rules, by = "lift"))
## filter spurious rules 
inspect(rules, by = "lift")
#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

#####


####### Codigo se Grafico ########

#Crear dataframe
rules_test <- rules[1:10,] # Filtro de reglas. 

df_rules = data.frame(
  lhs = labels(lhs(rules_test)),
  rhs = labels(rhs(rules_test)), 
  rules_test@quality)

#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
# Ajustar contenido de las celdas
df_rules$regla <- rownames(df_rules)
df_rules$lhs <- gsub("[\\{\\}]", "", df_rules$lhs)
df_rules$rhs <- gsub("[\\{\\}]", "", df_rules$rhs)

#### Ajustar a formato de tres tablas

## left hand 
lista <- str_split(df_rules$lhs,",")
names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame
df_reglas_lhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),titulo = unlist(lista), type = "from")

## right hand
lista <- str_split(df_rules$rhs,",")

names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame

df_reglas_rhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),
                            titulo = unlist(lista),type = "to")

df_reglas_lhs$regla <- paste("rule",df_reglas_lhs$regla,sep = "")
df_reglas_rhs$regla <- paste("rule",df_reglas_rhs$regla,sep = "")


# Propiedades
df_rules <- df_rules[,c("regla","support", "confidence", "lift")]
df_rules$regla <- paste("rule",df_rules$regla,sep = "")

df1 <- rbind(df_reglas_lhs,df_reglas_rhs)

df1n1 <- data.frame(edge = df1$regla, type = rep("regla",dim(df1)[1]))
df1n2 <- data.frame(edge = df1$titulo, type = rep("Condicion",dim(df1)[1]))
dfn <- rbind(df1n1,df1n2) 

colnames(df_reglas_rhs) <- c("origen","destino","type")
colnames(df_reglas_lhs) <- c("destino","origen","type")
df_reglas_gato <- rbind (df_reglas_lhs,df_reglas_rhs)

dfnodos <- dfn %>% group_by(edge,type) %>% summarise(n = n())

nodes1 <- data.frame(id = dfnodos$edge, group = dfnodos$type, label = dfnodos$edge)
edges1 <- data.frame(from = df_reglas_gato$origen ,to=df_reglas_gato$destino)
set.seed(1234)

a1<-visNetwork(nodes1, edges1, width = "90%") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  #visNodes(shape = "square") %>%                        # square for all nodes
  visEdges(arrows ="to") %>%                            # arrow "to" for all edges
  visGroups(groupname = "regla") %>%    # darkblue for group "A"
  visGroups(groupname = "Condicion",shape = "icon",icon = list(code = "f007", color = "pink"), color = "red")

```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart 1

```{r echo=FALSE}
a1
```


Column {data-width=350}
-----------------------------------------------------------------------

### Chart 3

```{r echo=FALSE}

datos %>% filter(Cluster %in% c("Cluster 2")) %>% group_by(EdadRango, Genero, Cluster) %>% summarise(Poblacion=n())%>% mutate(Edad = EdadRango) %>% ggplot() + geom_bar(aes(x=Edad, y = if_else(Genero=="M", -Poblacion,Poblacion), fill = Genero), stat="identity") + coord_flip() + facet_wrap( ~ Cluster, ncol = 2) +theme_minimal() + xlab("Edad")+ ylab("Observaciones") + scale_y_continuous(labels = abs)-> ggcaracterizacion2

ggplotly(ggcaracterizacion2)
``` 

### Chart C

```{r echo=FALSE}
knitr::include_graphics("/home/jennifer/Documentos/clusters/cluster2.png")
```

Cluster 3
===================================== 

```{r include=FALSE}
par_clust <- "x" #cluster
par_n <- 5 #Número de Cluster
par_tipo <- "confidence"

genes <- read.csv('cluster3.csv') 
#genes$edad1 <- gsub(",","-",genes$edad1)#Cambio de coma
#genes %<>% filter(cluster %in% c('c1','c5','c3','c4','c2'))
#genes %<>% filter(cluster %in% c('c1','c3','c5'))
#genes %<>% filter(gen %in% c("BARD1"))#,"BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"))

#genes %<>% select(-cluster)

#genes <- sapply(genes,as.factor)
#genes$cluster <- discretize(genes$cluster)
#genes$edad <- discretize(genes$edad)
#genes$sexo <- discretize(genes$sexo)
g <- as(genes, "transactions")
rules <- apriori(g, parameter = list(supp = 0.05, conf = 0.6, target = "rules"))
#rules <-sort(rules, by ="lift")
#gato <- as(rules,"data.frame")
gatos <- data.frame(lhs = labels(lhs(rules)), rhs = labels(rhs(rules)), rules@quality) 
gatos$id <- rownames(gatos)
gatos %>% filter((grepl("BRCA1",lhs)|grepl("BRCA2",lhs)|grepl("ATM",lhs))) %>% select(id)-> rules_filtered
rules_filtered <- as.vector(rules_filtered) #Filtro de reglas por gen.

#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

summary(rules)
inspect(rules)

#plot(rules[1:5], method="graph", control=list(type="items"))
#plot(rules[1:10], method="graph", control=list(type="items"))
#plot(rules[1:5], method="grouped", interactive=TRUE)
#plot(rules[10:15], method="graph", control=list(type="items"))
#plot(rules, method="graph", control=list(type="items"))
#plot(rules, method = "graph", control = list(type = "items", + engine = "graphviz"))

inspect(head(rules, by = "lift"))
## filter spurious rules 
inspect(rules, by = "lift")
#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

#####


####### Codigo se Grafico ########

#Crear dataframe
rules_test <- rules[1:10,] # Filtro de reglas. 

df_rules = data.frame(
  lhs = labels(lhs(rules_test)),
  rhs = labels(rhs(rules_test)), 
  rules_test@quality)

#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
# Ajustar contenido de las celdas
df_rules$regla <- rownames(df_rules)
df_rules$lhs <- gsub("[\\{\\}]", "", df_rules$lhs)
df_rules$rhs <- gsub("[\\{\\}]", "", df_rules$rhs)

#### Ajustar a formato de tres tablas

## left hand 
lista <- str_split(df_rules$lhs,",")
names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame
df_reglas_lhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),titulo = unlist(lista), type = "from")

## right hand
lista <- str_split(df_rules$rhs,",")

names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame

df_reglas_rhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),
                            titulo = unlist(lista),type = "to")

df_reglas_lhs$regla <- paste("rule",df_reglas_lhs$regla,sep = "")
df_reglas_rhs$regla <- paste("rule",df_reglas_rhs$regla,sep = "")


# Propiedades
df_rules <- df_rules[,c("regla","support", "confidence", "lift")]
df_rules$regla <- paste("rule",df_rules$regla,sep = "")

df1 <- rbind(df_reglas_lhs,df_reglas_rhs)

df1n1 <- data.frame(edge = df1$regla, type = rep("regla",dim(df1)[1]))
df1n2 <- data.frame(edge = df1$titulo, type = rep("Condicion",dim(df1)[1]))
dfn <- rbind(df1n1,df1n2) 

colnames(df_reglas_rhs) <- c("origen","destino","type")
colnames(df_reglas_lhs) <- c("destino","origen","type")
df_reglas_gato <- rbind (df_reglas_lhs,df_reglas_rhs)

dfnodos <- dfn %>% group_by(edge,type) %>% summarise(n = n())

nodes2 <- data.frame(id = dfnodos$edge, group = dfnodos$type, label = dfnodos$edge)
edges2 <- data.frame(from = df_reglas_gato$origen ,to=df_reglas_gato$destino)
set.seed(1234)

a2<-visNetwork(nodes1, edges1, width = "90%") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  #visNodes(shape = "square") %>%                        # square for all nodes
  visEdges(arrows ="to") %>%                            # arrow "to" for all edges
  visGroups(groupname = "regla") %>%    # darkblue for group "A"
  visGroups(groupname = "Condicion",shape = "icon",icon = list(code = "f007", color = "pink"), color = "red")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart 1

```{r echo=FALSE}
a2
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart 3

```{r echo=FALSE}

datos %>% filter(Cluster %in% c("Cluster 3")) %>% group_by(EdadRango, Genero, Cluster) %>% summarise(Poblacion=n())%>% mutate(Edad = EdadRango) %>% ggplot() + geom_bar(aes(x=Edad, y = if_else(Genero=="M", -Poblacion,Poblacion), fill = Genero), stat="identity") + coord_flip() + facet_wrap( ~ Cluster, ncol = 2) +theme_minimal() + xlab("Edad")+ ylab("Observaciones") + scale_y_continuous(labels = abs)-> ggcaracterizacion2

ggplotly(ggcaracterizacion2)
``` 

### Chart C

```{r echo=FALSE}
knitr::include_graphics("/home/jennifer/Documentos/clusters/cluster3.png")
```


Cluster 4
===================================== 

```{r include=FALSE}
par_clust <- "x" #cluster
par_n <- 5 #Número de Cluster
par_tipo <- "confidence"

genes <- read.csv('cluster4.csv') 
#genes$edad1 <- gsub(",","-",genes$edad1)#Cambio de coma
#genes %<>% filter(cluster %in% c('c1','c5','c3','c4','c2'))
#genes %<>% filter(cluster %in% c('c1','c3','c5'))
#genes %<>% filter(gen %in% c("BARD1"))#,"BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"))

#genes %<>% select(-cluster)

#genes <- sapply(genes,as.factor)
#genes$cluster <- discretize(genes$cluster)
#genes$edad <- discretize(genes$edad)
#genes$sexo <- discretize(genes$sexo)
g <- as(genes, "transactions")
rules <- apriori(g, parameter = list(supp = 0.05, conf = 0.6, target = "rules"))
#rules <-sort(rules, by ="lift")
#gato <- as(rules,"data.frame")
gatos <- data.frame(lhs = labels(lhs(rules)), rhs = labels(rhs(rules)), rules@quality) 
gatos$id <- rownames(gatos)
gatos %>% filter((grepl("BRCA1",lhs)|grepl("BRCA2",lhs)|grepl("ATM",lhs))) %>% select(id)-> rules_filtered
rules_filtered <- as.vector(rules_filtered) #Filtro de reglas por gen.

#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

summary(rules)
inspect(rules)

#plot(rules[1:5], method="graph", control=list(type="items"))
#plot(rules[1:10], method="graph", control=list(type="items"))
#plot(rules[1:5], method="grouped", interactive=TRUE)
#plot(rules[10:15], method="graph", control=list(type="items"))
#plot(rules, method="graph", control=list(type="items"))
#plot(rules, method = "graph", control = list(type = "items", + engine = "graphviz"))

inspect(head(rules, by = "lift"))
## filter spurious rules 
inspect(rules, by = "lift")
#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

#####


####### Codigo se Grafico ########

#Crear dataframe
rules_test <- rules[1:10,] # Filtro de reglas. 

df_rules = data.frame(
  lhs = labels(lhs(rules_test)),
  rhs = labels(rhs(rules_test)), 
  rules_test@quality)

#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
# Ajustar contenido de las celdas
df_rules$regla <- rownames(df_rules)
df_rules$lhs <- gsub("[\\{\\}]", "", df_rules$lhs)
df_rules$rhs <- gsub("[\\{\\}]", "", df_rules$rhs)

#### Ajustar a formato de tres tablas

## left hand 
lista <- str_split(df_rules$lhs,",")
names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame
df_reglas_lhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),titulo = unlist(lista), type = "from")

## right hand
lista <- str_split(df_rules$rhs,",")

names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame

df_reglas_rhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),
                            titulo = unlist(lista),type = "to")

df_reglas_lhs$regla <- paste("rule",df_reglas_lhs$regla,sep = "")
df_reglas_rhs$regla <- paste("rule",df_reglas_rhs$regla,sep = "")


# Propiedades
df_rules <- df_rules[,c("regla","support", "confidence", "lift")]
df_rules$regla <- paste("rule",df_rules$regla,sep = "")

df1 <- rbind(df_reglas_lhs,df_reglas_rhs)

df1n1 <- data.frame(edge = df1$regla, type = rep("regla",dim(df1)[1]))
df1n2 <- data.frame(edge = df1$titulo, type = rep("Condicion",dim(df1)[1]))
dfn <- rbind(df1n1,df1n2) 

colnames(df_reglas_rhs) <- c("origen","destino","type")
colnames(df_reglas_lhs) <- c("destino","origen","type")
df_reglas_gato <- rbind (df_reglas_lhs,df_reglas_rhs)

dfnodos <- dfn %>% group_by(edge,type) %>% summarise(n = n())

nodes3 <- data.frame(id = dfnodos$edge, group = dfnodos$type, label = dfnodos$edge)
edges3 <- data.frame(from = df_reglas_gato$origen ,to=df_reglas_gato$destino)
set.seed(1234)

a3<-visNetwork(nodes3, edges3, width = "90%") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  #visNodes(shape = "square") %>%                        # square for all nodes
  visEdges(arrows ="to") %>%                            # arrow "to" for all edges
  visGroups(groupname = "regla") %>%    # darkblue for group "A"
  visGroups(groupname = "Condicion",shape = "icon",icon = list(code = "f007", color = "pink"), color = "red")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart 1

```{r echo=FALSE}
a3
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart 3

```{r echo=FALSE}

datos %>% filter(Cluster %in% c("Cluster 4")) %>% group_by(EdadRango, Genero, Cluster) %>% summarise(Poblacion=n())%>% mutate(Edad = EdadRango) %>% ggplot() + geom_bar(aes(x=Edad, y = if_else(Genero=="M", -Poblacion,Poblacion), fill = Genero), stat="identity") + coord_flip() + facet_wrap( ~ Cluster, ncol = 2) +theme_minimal() + xlab("Edad")+ ylab("Observaciones") + scale_y_continuous(labels = abs)-> ggcaracterizacion2

ggplotly(ggcaracterizacion2)
``` 

### Chart C

```{r echo=FALSE}
knitr::include_graphics("cluster4.png")
```


Cluster 5
===================================== 

```{r include=FALSE}
par_clust <- "x" #cluster
par_n <- 5 #Número de Cluster
par_tipo <- "confidence"

genes <- read.csv('cluster5.csv') 
#genes$edad1 <- gsub(",","-",genes$edad1)#Cambio de coma
#genes %<>% filter(cluster %in% c('c1','c5','c3','c4','c2'))
#genes %<>% filter(cluster %in% c('c1','c3','c5'))
#genes %<>% filter(gen %in% c("BARD1"))#,"BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"))

#genes %<>% select(-cluster)

#genes <- sapply(genes,as.factor)
#genes$cluster <- discretize(genes$cluster)
#genes$edad <- discretize(genes$edad)
#genes$sexo <- discretize(genes$sexo)
g <- as(genes, "transactions")
rules <- apriori(g, parameter = list(supp = 0.05, conf = 0.6, target = "rules"))
#rules <-sort(rules, by ="lift")
#gato <- as(rules,"data.frame")
gatos <- data.frame(lhs = labels(lhs(rules)), rhs = labels(rhs(rules)), rules@quality) 
gatos$id <- rownames(gatos)
gatos %>% filter((grepl("BRCA1",lhs)|grepl("BRCA2",lhs)|grepl("ATM",lhs))) %>% select(id)-> rules_filtered
rules_filtered <- as.vector(rules_filtered) #Filtro de reglas por gen.

#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

summary(rules)
inspect(rules)

#plot(rules[1:5], method="graph", control=list(type="items"))
#plot(rules[1:10], method="graph", control=list(type="items"))
#plot(rules[1:5], method="grouped", interactive=TRUE)
#plot(rules[10:15], method="graph", control=list(type="items"))
#plot(rules, method="graph", control=list(type="items"))
#plot(rules, method = "graph", control = list(type = "items", + engine = "graphviz"))

inspect(head(rules, by = "lift"))
## filter spurious rules 
inspect(rules, by = "lift")
#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

#####


####### Codigo se Grafico ########

#Crear dataframe
rules_test <- rules[1:10,] # Filtro de reglas. 

df_rules = data.frame(
  lhs = labels(lhs(rules_test)),
  rhs = labels(rhs(rules_test)), 
  rules_test@quality)

#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
# Ajustar contenido de las celdas
df_rules$regla <- rownames(df_rules)
df_rules$lhs <- gsub("[\\{\\}]", "", df_rules$lhs)
df_rules$rhs <- gsub("[\\{\\}]", "", df_rules$rhs)

#### Ajustar a formato de tres tablas

## left hand 
lista <- str_split(df_rules$lhs,",")
names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame
df_reglas_lhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),titulo = unlist(lista), type = "from")

## right hand
lista <- str_split(df_rules$rhs,",")

names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame

df_reglas_rhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),
                            titulo = unlist(lista),type = "to")

df_reglas_lhs$regla <- paste("rule",df_reglas_lhs$regla,sep = "")
df_reglas_rhs$regla <- paste("rule",df_reglas_rhs$regla,sep = "")


# Propiedades
df_rules <- df_rules[,c("regla","support", "confidence", "lift")]
df_rules$regla <- paste("rule",df_rules$regla,sep = "")

df1 <- rbind(df_reglas_lhs,df_reglas_rhs)

df1n1 <- data.frame(edge = df1$regla, type = rep("regla",dim(df1)[1]))
df1n2 <- data.frame(edge = df1$titulo, type = rep("Condicion",dim(df1)[1]))
dfn <- rbind(df1n1,df1n2) 

colnames(df_reglas_rhs) <- c("origen","destino","type")
colnames(df_reglas_lhs) <- c("destino","origen","type")
df_reglas_gato <- rbind (df_reglas_lhs,df_reglas_rhs)

dfnodos <- dfn %>% group_by(edge,type) %>% summarise(n = n())

nodes4 <- data.frame(id = dfnodos$edge, group = dfnodos$type, label = dfnodos$edge)
edges4 <- data.frame(from = df_reglas_gato$origen ,to=df_reglas_gato$destino)
set.seed(1234)

a4<-visNetwork(nodes4, edges4, width = "90%") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  #visNodes(shape = "square") %>%                        # square for all nodes
  visEdges(arrows ="to") %>%                            # arrow "to" for all edges
  visGroups(groupname = "regla") %>%    # darkblue for group "A"
  visGroups(groupname = "Condicion",shape = "icon",icon = list(code = "f007", color = "pink"), color = "red")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart 1

```{r echo=FALSE}
a4
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart 3

```{r echo=FALSE}

datos %>% filter(Cluster %in% c("Cluster 5")) %>% group_by(EdadRango, Genero, Cluster) %>% summarise(Poblacion=n())%>% mutate(Edad = EdadRango) %>% ggplot() + geom_bar(aes(x=Edad, y = if_else(Genero=="M", -Poblacion,Poblacion), fill = Genero), stat="identity") + coord_flip() + facet_wrap( ~ Cluster, ncol = 2) +theme_minimal() + xlab("Edad")+ ylab("Observaciones") + scale_y_continuous(labels = abs)-> ggcaracterizacion2

ggplotly(ggcaracterizacion2)
``` 

### Chart C

```{r echo=FALSE}
knitr::include_graphics("/home/jennifer/Documentos/clusters/cluster5.png")
```

Variants per gene
===================================== 
Column {.sidebar}
-----------------------------------------------------------------------

Waiting time between eruptions and the duration of the eruption for the
Old Faithful geyser in Yellowstone National Park, Wyoming, USA.

```{r}
selectInput("n_breaks", label = "Gene",
            choices = c("BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"), selected = 20)
```


```{r include=FALSE}
par_clust <- "x" #cluster
par_n <- 1 #Número de Cluster
par_tipo <- "confidence"

genes <- read.csv('genesok.csv') 
#genes$edad1 <- gsub(",","-",genes$edad1)#Cambio de coma
#genes %<>% filter(cluster %in% c('c1'))
#genes %<>% filter(cluster %in% c('c1','c3','c5'))
genes %<>% filter(Gene %in% c("CFTR"))#,"BRCA1","ATM","MLH2", "PMS1", "MSH2", "MSH6,
                             #PMS2, EPCAM, STK11, APC, MUTYH, TP53, CDKN2A, 
                             #CDK4, PTEN, CDH1, BMPR1A, SMAD4, PALB2, ATM,
                             #CHEK2, NBN, BARD1, BRIP1, RAD51C, RAD51D, POLD, 
                             #POLE, GREM1"))

#genes %<>% select(-cluster)

#genes <- sapply(genes,as.factor)
#genes$cluster <- discretize(genes$cluster)
#genes$edad <- discretize(genes$edad)
#genes$sexo <- discretize(genes$sexo)
g <- as(genes, "transactions")
rules <- apriori(g, parameter = list(supp = 0.05, conf = 0.6, target = "rules"))
#rules <-sort(rules, by ="lift")
#gato <- as(rules,"data.frame")
gatos <- data.frame(lhs = labels(lhs(rules)), rhs = labels(rhs(rules)), rules@quality) 
gatos$id <- rownames(gatos)
gatos %>% filter((grepl("BRCA1",lhs)|grepl("BRCA2",lhs)|grepl("ATM",lhs))) %>% select(id)-> rules_filtered
rules_filtered <- as.vector(rules_filtered) #Filtro de reglas por gen.

#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

summary(rules)
inspect(rules)

#plot(rules[1:5], method="graph", control=list(type="items"))
#plot(rules[1:10], method="graph", control=list(type="items"))
#plot(rules[1:5], method="grouped", interactive=TRUE)
#plot(rules[10:15], method="graph", control=list(type="items"))
#plot(rules, method="graph", control=list(type="items"))
#plot(rules, method = "graph", control = list(type = "items", + engine = "graphviz"))

inspect(head(rules, by = "lift"))
## filter spurious rules 
inspect(rules, by = "lift")
#plot(rules[rules_filtered[1:30,1]], method="graph", control=list(type="items"))

#####


####### Codigo se Grafico ########

#Crear dataframe
rules_test <- rules[1:30,] # Filtro de reglas. 

df_rules = data.frame(
  lhs = labels(lhs(rules_test)),
  rhs = labels(rhs(rules_test)), 
  rules_test@quality)

#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))
#df_rules %<>% filter(grepl(par_clust,lhs)|grepl(par_clust,rhs))%>% top_n(par_n,par_tipo)
# Ajustar contenido de las celdas
df_rules$regla <- rownames(df_rules)
df_rules$lhs <- gsub("[\\{\\}]", "", df_rules$lhs)
df_rules$rhs <- gsub("[\\{\\}]", "", df_rules$rhs)

#### Ajustar a formato de tres tablas

## left hand 
lista <- str_split(df_rules$lhs,",")
names(lista) <- as.vector(df_rules[,"regla"])
 
## convert to data.frame
df_reglas_lhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),titulo = unlist(lista), type = "from")

## right hand
lista <- str_split(df_rules$rhs,",")

names(lista) <- as.vector(df_rules[,"regla"])

## convert to data.frame

df_reglas_rhs <- data.frame(regla = rep(names(lista), sapply(lista, length)),
                            titulo = unlist(lista),type = "to")

df_reglas_lhs$regla <- paste("rule",df_reglas_lhs$regla,sep = "")
df_reglas_rhs$regla <- paste("rule",df_reglas_rhs$regla,sep = "")


# Propiedades
df_rules <- df_rules[,c("regla","support", "confidence", "lift")]
df_rules$regla <- paste("rule",df_rules$regla,sep = "")

df1 <- rbind(df_reglas_lhs,df_reglas_rhs)

df1n1 <- data.frame(edge = df1$regla, type = rep("regla",dim(df1)[1]))
df1n2 <- data.frame(edge = df1$titulo, type = rep("Condicion",dim(df1)[1]))
dfn <- rbind(df1n1,df1n2) 

colnames(df_reglas_rhs) <- c("origen","destino","type")
colnames(df_reglas_lhs) <- c("destino","origen","type")
df_reglas_gato <- rbind (df_reglas_lhs,df_reglas_rhs)

dfnodos <- dfn %>% group_by(edge,type) %>% summarise(n = n())

nodes <- data.frame(id = dfnodos$edge, group = dfnodos$type, label = dfnodos$edge)
edges <- data.frame(from = df_reglas_gato$origen ,to=df_reglas_gato$destino)
set.seed(1234)

todo<-visNetwork(nodes, edges, width = "90%") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  #visNodes(shape = "square") %>%                        # square for all nodes
  visEdges(arrows ="to") %>%                            # arrow "to" for all edges
  visGroups(groupname = "regla") %>%    # darkblue for group "A"
  visGroups(groupname = "Condicion",shape = "icon",icon = list(code = "f007", color = "pink"), color = "red")
```

Reglas
-----------------------------------------------------------------------

```{r}
todo
```

